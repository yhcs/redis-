
@[TOC](redisæŒä¹…åŒ– ä¹‹ åé¢é¢è¯•å®˜)
# ç»™æ–°è§‚ä¼—è€çˆ·çš„å¼€åœº
å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼Ÿå¼Ÿï¼
æœ€è¿‘è¯»äº†ä¸€é é»„å¥å®å¤§ä½¬çš„ **<<Redis è®¾è®¡ä¸å®ç°>>**ï¼Œå¯¹Redis 3.0ç‰ˆæœ¬æœ‰äº†ä¸€äº›è®¤è¯†
è¯¥ä¹¦ä½œè€…æœ‰ä¸€ç‰ˆæ·»åŠ äº†æ³¨é‡Šçš„ redis 3.0æºç 
[ğŸ‘‰å®˜æ–¹redisçš„githubä¼ é€é—¨](https://github.com/antirez/redis)ã€‚
[ğŸ‘‰é»„å¥å®å¤§ä½¬æ·»åŠ äº†æ³¨é‡Šçš„ redis 3.0æºç ä¼ é€é—¨](https://github.com/huangz1990/redis-3.0-annotated.git)


ç½‘ä¸Šè¯´Redisä»£ç å†™å¾—å¾ˆå¥½ï¼Œä¸ºäº†åŠ æ·±å°è±¡å’Œå­¦ä¹ rediså¤§ä½¬çš„ä»£ç å†™ä½œè‰ºæœ¯ï¼Œäº†è§£å·¥ä½œä¸­ä½¿ç”¨çš„redis å‘½ä»¤èƒŒåçš„æºç é€»è¾‘ï¼Œä¾¿æœ‰äº†å†™åšå®¢è®°å½•å­¦ä¹ redisæºç è¿‡ç¨‹çš„æƒ³æ³•ã€‚


# redis æŒä¹…åŒ–
## é¢è¯•å®˜: "ä½ äº†è§£redisçš„æŒä¹…åŒ–å—ï¼Ÿ"
å€™é€‰äºº: "
1. redisæœ‰ä¸¤ç§æŒä¹…åŒ–æœºåˆ¶ï¼Œä¸€ç§æ˜¯rdbï¼Œä¸€ç§æ˜¯aof
2. rdbå¯ä»¥ç†è§£ä¸º"å…¨é‡å¤‡ä»½",å°†å½“å‰å…¨é‡çš„k/vé”®å€¼å¯¹å…¨éƒ¨å†™åˆ°æ–‡ä»¶ä¸­ã€‚
3. aofå¯ä»¥ç†è§£ä¸º"å¢é‡å¤‡ä»½",æ¯å½“æ”¶åˆ° éƒ¨åˆ†ç›¸å…³çš„rediså‘½ä»¤ï¼Œå°†å‘½ä»¤ä»¥æ–‡æœ¬å­—ç¬¦ä¸²çš„å½¢å¼è¿½åŠ å†™å…¥æ–‡ä»¶ä¸­ã€‚
4. å¦‚æœå¯ç”¨rdbæœºåˆ¶ï¼Œåœ¨redisæŒ‚æ‰çš„æ—¶å€™ï¼Œä¼šä¸¢å¤±ä¸Šä¸€æ¬¡rdbå¤‡ä»½åˆ°ç°åœ¨ä¹‹é—´çš„æ•°æ®
5. å¦‚æœå¯ç”¨aofæœºåˆ¶ï¼Œåœ¨redisæŒ‚æ‰çš„æ—¶å€™ï¼Œä½¿ç”¨aofé‡æ”¾å‘½ä»¤ä¸å¦‚ä¸€ä»½å®Œæ•´çš„rdbæ–‡ä»¶é€Ÿåº¦æ¥å¾—å¿«ã€‚
6. äºæ˜¯åœ¨redis4.0åŠä»¥åaofé‡å†™æ—¶ï¼Œå¯é…ç½® aofä¸rdbæ··åˆçš„æ–¹å¼ã€‚
aofé‡å†™æ—¶ï¼Œå…ˆä¿å­˜å½“å‰å…¨é‡rdbæ–‡ä»¶æ•°æ®ï¼Œä¿å­˜æœŸé—´æ–°çš„å‘½ä»¤ä»¥aofçš„å½¢å¼è¿½åŠ å†™å…¥ï¼Œè¿™æ ·redisæŒ‚æ‰é‡å¯æ—¶ï¼Œå¤§éƒ¨åˆ†æ•°æ®å¯ä»¥å¿«é€Ÿæ¢å¤ï¼Œä¹‹åçš„å¢é‡æ•°æ®ç”±aofè®°å½•ï¼Œrdbä¸aofä¼˜åŠ¿äº’è¡¥ï¼ŒçœŸæ­£çš„åˆå¿«åˆç¨³ğŸ˜‚  â€œ

é¢è¯•å®˜: (å—¯ï¼Œè¿™å°å­å›ç­”å¾—è¿˜ä¸é”™) 
## RDB
### é¢è¯•å®˜: "ä½ èƒ½è¯´è¯´rdbå…·ä½“æ˜¯æ€ä¹ˆå¤‡ä»½æ•°æ®çš„å—ï¼Ÿ"
å€™é€‰äºº: "
1. å¤‡ä»½rdbæ–‡ä»¶æœ‰ä¸¤ç§æ–¹å¼
2.  ä¸€ç§æ˜¯å‘½ä»¤ä¸»åŠ¨è§¦å‘ save, bgsave
   2.1  saveå°†é˜»å¡redisä¸»çº¿ç¨‹ï¼Œ
   2.2 bgsave ä½¿ç”¨ fork+copy on write å¼€å­è¿›ç¨‹æ¥å¤‡ä»½æ•°æ®
   ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œä½¿ç”¨çš„å†…å­˜ä¹Ÿä¸ä¼šçªç„¶ç¿»å€
3. ä¸€ç§æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®è‡ªåŠ¨å¤‡ä»½rdbæ¡ä»¶ æ¯”å¦‚ 60ç§’å†… >= 10000ä¸ªk/v æœ‰å˜åŒ–ï¼Œ5åˆ†é’Ÿå†… >= 10ä¸ªk/væœ‰å˜åŒ– å°†è§¦å‘bgsave"

### é¢è¯•å®˜: "é‚£å…·ä½“rdbçš„æ–‡ä»¶æ˜¯å¦‚ä½•ç”Ÿæˆçš„å‘¢ï¼Ÿ"
å€™é€‰äºº:ï¼ˆä¸å¥½æ„æ€ï¼Œæˆ‘åˆšå¥½çœ‹è¿‡ä¸€ç‚¹ï¼‰
å†™å…¥rdbæ–‡ä»¶ä¸­çš„æ•°æ®åŒ…æ‹¬
1. å½“å‰redisçš„æ‰€æœ‰k/vé”®å€¼å¯¹ï¼Œä»¥åŠè¿‡æœŸkeyçš„è¿‡æœŸæ—¶é—´
2. ä¸Šè¿°k/våˆ†åˆ«å±äºå“ªä¸€ä¸ªdbï¼Œä¹Ÿå°±æ˜¯dbidï¼Œ(å› ä¸ºæ¢å¤æ•°æ®çš„æ—¶å€™éœ€è¦ä½¿ç”¨ï¼‰
3. å½“å‰rdbæ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬å·

è‡³äºç”Ÿæˆrdbæ–‡ä»¶çš„ä»£ç é€»è¾‘ï¼Œæ‹¿bgsaveå‘½ä»¤æ¥ä¸¾ä¾‹å§ã€‚

1. åˆ¤æ–­ server.rdb_child_pid æ˜¯å¦ç­‰äº -1. 
1.1 ç­‰äº-1è¡¨ç¤ºå½“å‰æ²¡æœ‰å­è¿›ç¨‹è¿›è¡Œbgsaveæ“ä½œï¼Œæœ¬æ¬¡bgsaveå¯ä»¥æ­£å¸¸æ‰§è¡Œ
1.2 ä¸ç­‰äº-1ï¼Œè¡¨ç¤ºæ­£åœ¨è¿›è¡Œbgsaveçš„å­è¿›ç¨‹çš„pidï¼Œæœ¬æ¬¡bgsaveä¸ä¼šçœŸæ­£æ‰§è¡Œã€‚
2. childpid = fork() åˆ›å»ºå­è¿›ç¨‹
2.1 çˆ¶è¿›ç¨‹ä¼šè®°å½•forkè€—æ—¶,å­è¿›ç¨‹pid,å…³é—­è‡ªåŠ¨rehash,æ ‡è®° dict_can_resize = 0
2.2 å­è¿›ç¨‹å°†å…³é—­ç½‘ç»œè¿æ¥å¥—æ¥å­—ï¼Œç„¶åå¼€å§‹æ‰§è¡ŒçœŸæ­£çš„rdbSaveå‡½æ•°,åœ¨è¯¥å‡½æ•°ä¸­ä¼šç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„rdbæ–‡ä»¶

rdbSaveå‡½æ•°å°†æŒ‰ç…§rdbæ–‡ä»¶æ ¼å¼å†™å…¥æ•°æ®ï¼Œé€»è¾‘å¦‚ä¸‹
1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç”¨äºå†™å…¥æ•°æ®
    ```javascript
    snprintf(tmpfile,256,"temp-%d.rdb", (int) getpid());
    fp = fopen(tmpfile,"w");
   ```
4. å†™å…¥ rdbç‰ˆæœ¬å·
    ```javascript
	 //The current RDB version. When the format changes in a way that is no longer
     //backward compatible this number gets incremented.
     //RDB çš„ç‰ˆæœ¬ï¼Œå½“æ–°ç‰ˆæœ¬ä¸å‘æ—§ç‰ˆæœ¬å…¼å®¹æ—¶ï¼Œå¢ä¸€
     #define REDIS_RDB_VERSION 6
    ... 
    snprintf(magic,sizeof(magic),"REDIS%04d",REDIS_RDB_VERSION);
    if (rdbWriteRaw(&rdb,magic,9) == -1) goto werr;
    ...
   ```
5. è·³è¿‡ç©ºçš„dbå­—å…¸
  å†™å…¥dbé€‰æ‹©ç  254 ä»¥åŠdbidï¼Œ è®°å½•æ¥ä¸‹æ¥çš„æ•°æ®ï¼ŒåŸæ¥å±äºå“ªä¸ªdb
6. éå†å½“å‰dbå­—å…¸ï¼Œå–å‡ºkey,value,ä»¥åŠkeyçš„è¿‡æœŸæ—¶é—´
å¦‚æœkeyè¿‡æœŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªk/vä¸ä¼šå†™å…¥rdbæ–‡ä»¶
å¦‚æœkeyæ²¡è¿‡æœŸï¼Œå†™å…¥è¿‡æœŸæ—¶é—´ï¼Œkeyï¼Œvalue ç›¸å…³çš„å€¼
å¦‚æœkeyæ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œä»…å†™å…¥ key, value ç›¸å…³çš„å€¼
7. æ‰€æœ‰k/vå†™å…¥ä¹‹åï¼Œæœ€åå†™å…¥EOFç  255
8. åœ¨å†™å…¥ 8ä¸ªå­—èŠ‚çš„ crcæ ¡éªŒç 
9. fflushã€fsyncã€fclose ä¸‰è¿åŒæ­¥åˆ°æ–‡ä»¶å¹¶å…³é—­fd
10. å­è¿›ç¨‹ä»¥ä¸€ä¸ªé€€å‡ºç ç»“æŸé€€å‡ºï¼Œè¡¨ç¤º bgsave æ‰§è¡Œ æˆåŠŸ or å¤±è´¥
11. ä¸»è¿›ç¨‹åœ¨æ¯æ¬¡ serverCron æ—¶ï¼Œä¼šä½¿ç”¨wait3()æ¥è·å–ç»“æŸå­è¿›ç¨‹çš„ä¿¡æ¯
è‹¥è·å–åˆ°rdbå­è¿›ç¨‹çš„ç»“æŸä¿¡æ¯ ï¼Œä¼šå°† server.rdb_child_pid ç½®ä¸º-1ï¼Œå¹¶æ›´æ–°ç›¸å…³çš„ä¿¡æ¯ã€‚

é¢è¯•å®˜: "å—¯ï¼Œä¸é”™ï¼Œå›ç­”å¾—å¾ˆè¯¦ç»†"
å€™é€‰äºº: "å—¯ï¼Œè¿™ä¸ªè¿˜æ²¡è¯´å®Œ"
### é¢è¯•å®˜: ï¼ˆéš¾é“è¿™å°å­è¦åé¢æˆ‘ ğŸ˜‚ï¼‰

å€™é€‰äºº: "
å¯¹äºå…·ä½“çš„ key/value/è¿‡æœŸæ—¶é—´ å¦‚ä½•ä¿å­˜è¿˜æ²¡è¯´ï¼Œå®é™…ä¸Šè¿™ä¹Ÿæ˜¯ ä¿å­˜rdbæ–‡ä»¶ä¸­éªšæ“ä½œæœ€å¤šçš„åœ°æ–¹ï¼Œåº”è¯¥éœ€è¦é‡ç‚¹è®²ä¸€ä¸‹ã€‚

> å®é™…ä¸Šå¯¹äºè¯»/å†™æ–‡ä»¶æ¥è¯´ï¼Œå†™å…¥çš„å†…å®¹ç”Ÿå‰åˆ°åº•æ˜¯ä»€ä¹ˆæ•°æ®ç»“æ„æ˜¯ä¸å…³å¿ƒçš„ã€‚
è¯»/å†™æ–‡ä»¶åªå…³å¿ƒï¼Œè¦ä»å“ªä¸ªåœ°å€å¼€å§‹ï¼Œè¦æ“ä½œå¤šå°‘ä¸ªå­—èŠ‚ï¼Œå®Œäº‹ã€‚
ä»€ä¹ˆè·³è·ƒè¡¨ï¼Œå“ˆå¸Œè¡¨ï¼Œ ç«™åœ¨è¯»/å†™æ–‡ä»¶çš„è§’åº¦æ¥çœ‹å®é™…ä¸Šéƒ½ä¸€æ ·ã€‚
å½“æˆ‘çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰ç¬¬ä¸€æ¬¡ä½“ä¼šåˆ°äº†ä»€ä¹ˆå«  `æ–‡ä»¶æµ`ã€‚
1. è¦åœ¨æ–‡ä»¶ä¸­ä¿å­˜ å„ç§æ•°æ®ç»“æ„å˜é‡ æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œå› ä¸ºæ¢å¤çš„æ—¶å€™è¿˜è¦å¯¹ä»æ–‡ä»¶æµé‡Œè¯»å‡ºæ¥çš„æ•°æ®è¿›è¡Œè¯†åˆ«ï¼Œå“ªä¸€å¨æ˜¯ä»€ä¹ˆç»“æ„ã€‚
ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œrediså†™å…¥rdbæ–‡ä»¶çš„å˜é‡ç±»å‹ï¼Œ å¤§æ¦‚æœ‰ä¸‰ç±»

  2. `ç›´æ¥å†™å…¥çš„ 1å­—èŠ‚ æ ‡è¯†ç `ï¼Œæ¯”å¦‚ é€‰æ‹©dbçš„æ“ä½œç  254, ç»“æŸæ ‡è®°EOF 255 
  3. `æ•´æ•°å˜é‡`ï¼Œå› å˜é‡å¤§å°ä¸åŒï¼Œä¸ºäº†èŠ‚çœç©ºé—´ä¸€å…±åˆ†ä¸ºäº† 6ä½/14ä½/32ä½ ä¸‰ç§æ•°å­—ï¼Œå¹¶ä¸”åœ¨ä½å­—èŠ‚ç”¨é¢å¤–2ä½ è¡¨ç¤º ç±»å‹ç  ä¹Ÿå°±æ˜¯è¡¨ç¤ºæ•°å­—ç±»å‹ï¼Œè¿™æ ·æ¢å¤çš„æ—¶å€™æ‰èƒ½è¯»å‡ºæ­£ç¡®çš„æ•°å­—
  4. `å­—ç¬¦ä¸²å˜é‡`
     4.1 ä¸€ç±»æ˜¯å¯ä»¥è¡¨ç¤ºä¸ºæ•°å­—çš„å­—ç¬¦ä¸²å˜é‡ï¼Œä½¿ç”¨çš„è¡¨ç¤ºæ–¹æ³•è·Ÿæ•´æ•°å˜é‡ç±»ä¼¼ã€‚
     4.2 ä¸€ç±»æ˜¯ä¸èƒ½è¡¨ç¤ºä¸ºæ•°å­—ä¸”ä¸èƒ½è¢«å‹ç¼©çš„å­—ç¬¦ä¸²å˜é‡ï¼Œä¼šå°† å­—ç¬¦ä¸²é•¿åº¦ ä»¥æ•´å½¢å˜é‡çš„å½¢å¼ä¿å­˜ä¸‹æ¥ï¼Œç„¶åå†å†™å…¥å­—ç¬¦ä¸²ã€‚
     4.3 ä¸€ç±»æ˜¯å¯ä»¥è¢«å‹ç¼©çš„å­—ç¬¦ä¸²å˜é‡ï¼Œä¼šå†™å…¥è¢«å‹ç¼©æ ‡è¯†ç ï¼Œå‹ç¼©åå­—ç¬¦ä¸²é•¿åº¦ï¼Œå‹ç¼©é’±å­—ç¬¦ä¸²é•¿åº¦ï¼Œå‹ç¼©åå­—ç¬¦ä¸²ã€‚

 
 æœ‰äº†ä¸Šè¿°çš„ä¸‰ç±»åŸºæœ¬ç»“æ„ï¼Œæ‹¿ ä¿å­˜ç›¸å¯¹å¤æ‚ä¸€äº›çš„ zset æ•°æ®ç±»å‹çš„æ“ä½œï¼Œæ¥è®²è®²ä¸€è®²redisçš„é”®å€¼å¯¹ï¼Œæœ€åæ˜¯æ€ä¹ˆä¿å­˜åœ¨rdbä¸­çš„
1.  å¦‚æœkeyæœ‰è¿‡æœŸæ—¶é—´ï¼Œå†™å…¥ è¿‡æœŸæ—¶é—´æ ‡è¯†ç  252ï¼Œä¸”åé¢ç´§è·Ÿä¸€ä¸ª8å­—èŠ‚çš„è¿‡æœŸæ—¶é—´æˆ³
3. å†™å…¥1ä¸ªvalueçš„ç±»å‹æ ‡è¯†ç  (å®é™…ä¸Šè¿™ä¸ªæ ‡è¯†ç  åŒæ—¶è¡¨ç¤ºäº† valueçš„æ•°æ®ç±»å‹ï¼Œç¼–ç ç±»å‹ ä»¥åŠè¡¨ç¤ºåé¢è·Ÿç€çš„æ˜¯ä¸€å¯¹ key/value ï¼Œå› ä¸ºkeyéƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ‰€ä»¥åªè®°valueçš„å°±å¥½äº†)
   ```javascript
	/* Dup object types to RDB object types. Only reason is readability (are we
	 * dealing with RDB types or with in-memory object types?).
	 *
	 * å¯¹è±¡ç±»å‹åœ¨ RDB æ–‡ä»¶ä¸­çš„ç±»å‹
	 */
	#define REDIS_RDB_TYPE_STRING 0
	#define REDIS_RDB_TYPE_LIST   1 //é»˜è®¤çš„åŒå‘é“¾è¡¨å®ç°çš„é“¾è¡¨
	#define REDIS_RDB_TYPE_SET    2 //é»˜è®¤çš„å“ˆå¸Œè¡¨å®ç°çš„é›†åˆ
	#define REDIS_RDB_TYPE_ZSET   3 //é»˜è®¤çš„è·³è·ƒè¡¨å®ç°çš„æœ‰åºé›†åˆ
	#define REDIS_RDB_TYPE_HASH   4 //é»˜è®¤çš„å“ˆå¸Œè¡¨å®ç°çš„å“ˆå¸Œæ•°æ®ç±»å‹
	
	/* Object types for encoded objects.
	 *
	 * å¯¹è±¡çš„ç¼–ç æ–¹å¼
	 */
	#define REDIS_RDB_TYPE_HASH_ZIPMAP    9 
	#define REDIS_RDB_TYPE_LIST_ZIPLIST  10 //å‹ç¼©åˆ—è¡¨å®ç°çš„é“¾è¡¨
	#define REDIS_RDB_TYPE_SET_INTSET    11 //æ•´æ•°é›†åˆå®ç°çš„é›†åˆ
	#define REDIS_RDB_TYPE_ZSET_ZIPLIST  12 //å‹ç¼©åˆ—è¡¨å®ç°çš„æœ‰åºé›†åˆ
	#define REDIS_RDB_TYPE_HASH_ZIPLIST  13 //å‹ç¼©åˆ—è¡¨å®ç°çš„å“ˆå¸Œè¡¨
   ```
  4. å†™å…¥keyå¯¹åº”çš„å­—ç¬¦ä¸²
  5. æ ¹æ®valueçš„ç±»å‹ï¼Œå¤„ç†æœ‰åºé›†åˆ(è¿™é‡Œæ‹¿æœ‰åºé›†åˆæ¥ä¸¾ä¾‹å­)
4.1 å¦‚æœæ˜¯å‹ç¼©åˆ—è¡¨å®ç°çš„ï¼Œç›´æ¥å°† å‹ç¼©åˆ—è¡¨å ç”¨çš„ç©ºé—´å­—èŠ‚æ•°ä½œä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ•´ä¸ªå‹ç¼©åˆ—è¡¨ å½“ä½œä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†™å…¥rdbæ–‡ä»¶ã€‚
      > å› ä¸ºå‹ç¼©åˆ—è¡¨æœ¬èº«å°±æ˜¯ç´§å‡‘çš„ä¸€ä¸²å†…å­˜ç©ºé—´
  
     4.2 å¦‚æœæ˜¯è·³è·ƒè¡¨å®ç°çš„ï¼Œå†™å…¥å…ƒç´ ä¸ªæ•°ï¼Œ éå†è·³è·ƒè¡¨ä¸­çš„å­—å…¸ï¼Œå°†æ‰€æœ‰çš„ value/score 
     åˆ†åˆ«ä»¥ value å­—ç¬¦ä¸²å½¢å¼ï¼Œ scroe ç‰¹æ®Šæ ‡è¯†ç /æˆ–è€…å­—ç¬¦ä¸²å½¢å¼ å†™å…¥rdbæ–‡ä»¶ä¸­
     > å› ä¸º scoreæ˜¯æµ®ç‚¹æ•° æ­£æ— ç©·ï¼Œè´Ÿæ— ç©·ï¼Œæˆ–è€…ä¸æ˜¯ä¸€ä¸ªæ•° å¯ä»¥ç”¨ç‰¹æ®Šæ ‡è¯†ç¬¦æ¥è¡¨ç¤ºï¼Œå¦‚æœæ˜¯æ­£å„¿å…«ç»çš„æµ®ç‚¹æ•°ï¼Œå°†è½¬æ¢æˆå­—ç¬¦ä¸²æ¥è¡¨ç¤º
     
     > `ä¸ºä»€ä¹ˆè¿™é‡Œåªæ˜¯éå†äº† è·³è·ƒè¡¨ä¸­çš„å­—å…¸å–å‡ºæ‰€æœ‰ value/score å†™å…¥rdbå‘¢?é‚£è¿™ä¸ªè·³è·ƒè¡¨çš„å±‚é«˜å‘¢ï¼Œå„ä¸ªvalueçš„é¡ºåºï¼Œä¸å­˜äº†å—ï¼Ÿ`
     æ˜¯çš„ï¼Œä¸å­˜äº†ã€‚è¿™äº›ä¿¡æ¯ï¼Œå…¶å®åœ¨æ¢å¤rdbæ–‡ä»¶çš„æ—¶å€™ æ ¹æ®value/scoreæ˜¯å¯ä»¥é‡å»ºè¿™ä¸ªè·³è·ƒè¡¨çš„ï¼Œè€Œä¸”å‡å°‘è¿™äº›å†—ä½™çš„ä¿¡æ¯ï¼Œå¯ä»¥å‡å°‘rdbæ–‡ä»¶çš„ä½“ç§¯ï¼Œæé«˜rdbæ–‡ä»¶ç”Ÿæˆçš„é€Ÿåº¦ã€‚

"
å€™é€‰äºº: "
1. é™¤äº†ä¸Šè¿°çš„è¿™äº›ä¸ºäº†èŠ‚çœrdbæ–‡ä»¶ç©ºé—´çš„éªšæ“ä½œä»¥å¤–ï¼Œå¯¹å­—ç¬¦ä¸²åœ¨ä¸€å®šæƒ…å†µä¸‹ä¹Ÿæ˜¯ä¼šè¿›è¡Œå‹ç¼©çš„ï¼Œredisä¸­ä½¿ç”¨äº† lzf å‹ç¼©ç®—æ³•ã€‚å¯ä»¥é€šè¿‡é…ç½®å¯ç”¨è¯¥ç®—æ³•ã€‚"
2. è¯¥ç®—æ³•å…·æœ‰ o(1xn)çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ¯”è¾ƒé€‚åˆredisè¿™ç§å¯¹æ€§èƒ½æœ‰ç‚¹è¦æ±‚çš„è½¯ä»¶ä½¿ç”¨ã€‚ ä½†å¿«å’Œé«˜å‹ç¼©ç‡ è¿™ä¸¤è€…æ¯”è¾ƒéš¾å…¼å¾—ï¼Œè¯¥ç®—æ³•çš„å‹ç¼©ç‡æ˜¯ä¸ç¨³å®šçš„ã€‚
ä¸èƒ½ä¿è¯ä¸€å®šèƒ½å‹ç¼©ï¼Œè¯¥ç®—æ³•æ— æ³•å¯¹ä¸€äº›å­—ç¬¦ä¸²è¿›è¡Œå‹ç¼©çš„æƒ…å†µä¹Ÿæ˜¯æœ‰çš„ã€‚

   å…·ä½“çš„åŸå› åœ¨äº 
2.1 è¯¥ç®—æ³•ä¼šä»å¤´åˆ°å°¾éå†éœ€è¦å‹ç¼©çš„å­—ç¬¦ä¸²ï¼Œ
2.2 å¹¶é‡‡æ ·ç»Ÿè®¡ "ç¬¬ä¸€æ¬¡å‡ºç°çš„å­ä¸²"  
2.3 å¦‚æœåé¢è¯¥å­ä¸²é‡å¤å‡ºç°ï¼Œ
2.4 è®°å½•è¯¥å­ä¸²è·ç¦»å‰é¢è¢«é‡å¤çš„å­ä¸²çš„åç§»é‡ï¼Œä»¥åŠé‡å¤çš„é•¿åº¦å°±okäº† 
2.5 æ˜¾ç„¶è¯¥ç®—æ³•åœ¨å­—ç¬¦ä¸²ä¸­å­˜åœ¨å¤§é‡é‡å¤å­ä¸²çš„æƒ…å†µä¸‹ï¼Œå‹ç¼©ç‡é«˜
2.6 è¯¥ç®—æ³•åœ¨å­—ç¬¦ä¸²ä¸­ä¸å­˜åœ¨å¤§é‡é‡å¤å­ä¸²çš„æƒ…å†µä¸‹ï¼Œå‹ç¼©ç‡ä½
    >  å¯¹æ¯”æµ‹è¯•äº† ä¸€ä¸ªé•¿åº¦ä¸º100ä¸‡çš„å­—ç¬¦ä¸²ï¼Œåœ¨ä¸åŒæƒ…å†µä¸‹çš„å‹ç¼©ç‡
    > å¦‚æœæ¯ä¸ªå­—ç¬¦æ˜¯åœ¨26ä¸ªä¸åŒçš„å­—æ¯ä¸­éšæœºäº§ç”Ÿçš„ å‹ç¼©åå¤§å°ä¸ºåŸä¸²çš„ 91.5%
    > å¦‚æœæ¯ä¸ªå­—ç¬¦æ˜¯åœ¨10ä¸ªä¸åŒçš„å­—æ¯ä¸­éšæœºäº§ç”Ÿçš„ å‹ç¼©åå¤§å°ä¸ºåŸä¸²çš„ 64.3%
    > å¦‚æœæ˜¯100ä¸‡ä¸ªç›¸åŒçš„å­—æ¯ï¼Œå‹ç¼©åå¤§å°ä¸ºåŸä¸²çš„ 1.13%
    > lzfç®—æ³•ï¼Œå‹ç¼©/è§£å‹ä»£ç å¸¦æ³¨é‡Šä¸è¶…è¿‡500è¡Œï¼Œå¯ä»¥è¯´æ˜¯å¾ˆè½»é‡äº†
    > [lzfå‹ç¼©ç®—æ³•ç½‘ç«™](http://liblzf.plan9.de/)
    > [lzfå‹ç¼©ç®—æ³•æºç ä¸‹è½½](http://dist.schmorp.de/liblzf/)

"
é¢è¯•å®˜: (å—¯ï¼Œä¸é”™ä¸é”™ï¼Œè¿™å°å­æœ‰ç‚¹ä¸œè¥¿)
### é¢è¯•å®˜: "redisæ˜¯å¦‚ä½•é€šè¿‡rdbæ–‡ä»¶æ¢å¤æ•°æ®çš„å‘¢ï¼Ÿ"
å€™é€‰äºº: "
1. redisä½œä¸ºç¼“å­˜æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå¦‚æœå¼€å¯äº†rdbï¼Œä¼šæ ¹æ®é…ç½®æŸ¥æ‰¾çš„rdbæ–‡ä»¶
2. æ‰¾åˆ°äº†çš„è¯ï¼Œå…¶å®æŒ‰ç…§å†™å…¥rdbæ–‡ä»¶çš„é¡ºåºå’Œæ ¼å¼è§£å‡ºæ•°æ®å°±è¡Œäº†ã€‚
3. ä½†æ˜¯ä»…é rdbä¸­è¯»å‡ºæ¥çš„æ•°æ®è¿˜ä¸èƒ½å®Œæ•´çš„è¿˜åŸå¯¹åº”çš„æ•°æ®ç»“æ„ï¼Œ
3. æ¯”å¦‚ä¸Šé¢æ‰€è¯´çš„zsetï¼Œå½“å‘ç°è¦è¯»ä¸€ä¸ªzsetæ—¶ï¼Œ
redisä¼šåƒå¹³æ—¶åˆ›å»ºzsetä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ªzsetæ•°æ®ç»“æ„ï¼Œ
å¹¶å°†å„ä¸ªvalue/score æ¨¡æ‹Ÿæ·»åŠ è¿›å»ï¼Œä»¥æ­¤è¿˜åŸå‡ºæ­£ç¡®çš„æ•°æ®ç»“æ„
"

## AOF
### é¢è¯•å®˜: "AOFæ˜¯æ€ä¹ˆå¤‡ä»½æ•°æ®çš„ï¼Ÿ"
å€™é€‰äºº: "
å¦‚æœ é…ç½®æ–‡ä»¶ä¸­ appendonly è®¾ç½®ä¸ºyes å¯åŠ¨redisçš„è¯ï¼ŒAOFåŠŸèƒ½å°†è¢«å¼€å¯ã€‚
1. å½“rediså¤„ç†ä¸€ä¸ªå‘½ä»¤åï¼Œè®¡ç®—dirtyå€¼(è¯¥å‘½ä»¤æœ‰æ²¡æœ‰ä¿®æ”¹å†…å­˜æ•°æ®)
2. å¦‚æœè¯¥å‘½ä»¤ä¿®æ”¹äº†å†…å­˜æ•°æ®ï¼Œç”¨è¯¥å‘½ä»¤ [RESPåè®®æ ¼å¼](http://www.redis.cn/topics/protocol.html)çš„å­—ç¬¦ä¸²å…ˆå†™å…¥å…¨å±€çš„AOFç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯server.aof_bufã€‚
å¦‚æœæœ‰å¿…è¦æŒ‡æ˜å‘½ä»¤æ˜¯å†™åˆ°å“ªä¸ªdbçš„è¯ï¼Œè¿˜ä¼šå†™å…¥ä¸€ä¸ªé€‰æ‹©dbå·çš„å‘½ä»¤
    > æ¯”å¦‚ "SET mykey myvalue" å‘½ä»¤ï¼Œ å®é™…å†™å…¥çš„å­—ç¬¦ä¸²æ˜¯ "*3\r\n$3\r\nSET\r\n$5\r\nmykey\r\n$7\r\nmyvalue\r\n"
    å®é™…ä¸Šrediså®¢æˆ·ç«¯å‘åˆ°redisæœåŠ¡å™¨çš„å‘½ä»¤å°±æ˜¯é•¿è¿™ä¸ªæ ·å­çš„ã€‚
    ä»¥åŸå‘½ä»¤å­—ç¬¦ä¸²çš„å½¢å¼è®°å½•AOFæ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨AOFæ–‡ä»¶æ¢å¤æ•°æ®æ—¶æ¯”è¾ƒæ–¹ä¾¿ã€‚åœ¨å†…éƒ¨èµ·ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯ï¼Œç›´æ¥é‡æ”¾å‘½ä»¤æ¢å¤æ•°æ®
 3. åœ¨redisä¸»çº¿ç¨‹çš„å¾ªç¯é€»è¾‘é‡Œï¼Œæ¯è½®äº‹ä»¶è½®è®­å‰éƒ½ä¼šæ‰§è¡Œ beforeSleep å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­ä¼šå°† server.aof_bufçš„å†…å®¹å°è¯•å†™å…¥aofæ–‡ä»¶å¹¶åŒæ­¥
    3.1 å¦‚æœåå°çº¿ç¨‹è¿˜æœ‰åŒæ­¥åˆ°æ–‡ä»¶çš„ä»»åŠ¡æ²¡å®Œæˆï¼Œå°±ä¼šç­‰ä¸€ä¼šå„¿å†å†™
    3.2 å¦‚bgsave,bgrewriteæ²¡æ‰§è¡Œå®Œï¼Œä¹Ÿç­‰ä¸€ä¼šå„¿å†åŒæ­¥
 5. å†™å…¥aof_bufåˆ°æ–‡ä»¶ä¹‹åï¼Œå°±æ˜¯AOFçš„åŒæ­¥ç­–ç•¥äº†ï¼ŒåŒæ­¥ç­–ç•¥æ˜¯å¯é…ç½®çš„ã€‚
    ```javascript
	/* Append only defines */
	#define AOF_FSYNC_NO 0          //ä¸ä¸»åŠ¨è§¦å‘åŒæ­¥ï¼Œä¾èµ–ç³»ç»Ÿè‡ªå·±åŒæ­¥
	#define AOF_FSYNC_ALWAYS 1      //æ€»æ˜¯åŒæ­¥
	#define AOF_FSYNC_EVERYSEC 2    //è¶…è¿‡1ç§’åŒæ­¥ä¸€æ¬¡
	#define REDIS_DEFAULT_AOF_FSYNC AOF_FSYNC_EVERYSEC //é»˜è®¤åŒæ­¥ç­–ç•¥
    ```
 
      4.1    å¯¹äº AOF_FSYNC_ALWAYS ç­–ç•¥ï¼Œæ¯æ¬¡å°†aof_bufå†™å…¥aofæ–‡ä»¶åï¼Œå°±åœ¨å½“å‰çš„ä¸»çº¿ç¨‹ä¸­è°ƒç”¨fsyncå‡½æ•°åŒæ­¥ã€‚
      4.2   å¯¹äº AOF_FSYNC_EVERYSEC ç­–ç•¥ï¼Œè‹¥è¶…è¿‡1ç§’åï¼Œä¼šå°†æœ¬æ¬¡åŒæ­¥ä»»åŠ¡ï¼Œä½¿ç”¨é”çš„æ–¹å¼ï¼Œå†™å…¥å…¨å±€ä»»åŠ¡é˜Ÿåˆ—ã€‚åœ¨åˆ«çš„çº¿ç¨‹ä¸­å–å‡ºè¯¥ä»»åŠ¡è°ƒç”¨ fsyncå‡½æ•°åŒæ­¥åˆ°æ–‡ä»¶ã€‚
      >  æ²¡é”™ï¼Œè¿™é‡Œä¼šç”¨åˆ°é”ã€‚rediså†…éƒ¨ï¼Œå¯¹äºæ–‡ä»¶åŒæ­¥æ˜¯æœ‰å¦å¤–çš„çº¿ç¨‹æ¥å•ç‹¬å¤„ç†çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæœ‰ä¸€ç‚¹ç‚¹ ä½¿ç”¨é”æ¥è§£å†³å¤šçº¿ç¨‹çš„å…±äº«å˜é‡è¯»å†™é—®é¢˜ã€‚

### é¢è¯•å®˜: "AOFæ–‡ä»¶æœ‰ä»€ä¹ˆå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å—ï¼Ÿ"
å€™é€‰äºº: (è¿™ä¸å°±æ˜¯ AOFæ–‡ä»¶é‡å†™å—ï¼Œè¿˜å¥½æˆ‘çœ‹è¿‡ ğŸ˜‚)
"
1. åƒä¸Šè¿°çš„AOFæ–‡ä»¶ï¼Œä¼šå­˜ä¸‹æ¥ä¸€äº›å†—ä½™çš„å‘½ä»¤ã€‚
   >æ¯”å¦‚è®¾ç½®äº†ä¸€ä¸ªè¿‡æœŸkey/valueï¼Œä¸€å®šæ—¶é—´ä¹‹åï¼Œè¿™ä¸ªkey/valueå®é™…å·²ç»ä¸éœ€è¦äº†ã€‚
åˆæ¯”å¦‚è®¾ç½®äº†ä¸€ä¸ªkey/valueï¼Œåé¢è¿™ä¸ªkey/value è¢«åˆ æ‰äº†ï¼Œé‚£AOFæ–‡ä»¶é‡Œï¼Œè¯¥key/valueçš„è®¾ç½®/åˆ é™¤å‘½ä»¤ï¼Œå®é™…ä¸Šå°±æ˜¯å†—ä½™çš„ã€‚

2. è¿™ä¸ªæ—¶å€™å°±éœ€è¦AOFæ–‡ä»¶é‡å†™äº†ï¼Œå°†åŸæœ¬æ–‡ä»¶é‡Œçš„å†—ä½™å‘½ä»¤å…¨éƒ¨åˆ æ‰ï¼Œåªä¿ç•™æ¢å¤æ•°æ®éœ€è¦çš„æœ€å°‘çš„ä¿¡æ¯å°±å¯ä»¥äº†ï¼Œè¿™æ ·AOFçš„æ–‡ä»¶å¤§å°ä¼šç¼©å°ï¼ŒåŒ…å«çš„å‘½ä»¤æ•°ä¹Ÿä¼šå‡å°‘ï¼Œè‡ªç„¶ä½¿ç”¨AOFæ–‡ä»¶æ¢å¤æ•°æ®æ˜¯ï¼Œä¹Ÿä¼šæ›´å¿«ä¸€äº›ã€‚

3. å½“ç„¶AOFé‡å†™å‘½ä»¤ï¼Œä¸Šé¢ä¹Ÿè¯´äº†ã€‚
åœ¨4.0ä¹‹å AOFé‡å†™æ˜¯å¯ä»¥å…ˆä¿å­˜ä¸€ä»½å®Œæ•´çš„rdbæ–‡ä»¶ï¼Œç„¶åå†rdbæ–‡ä»¶ä¹‹åå†è¿½åŠ å†™å…¥å¢é‡çš„AOFæ–‡ä»¶å†…å®¹ã€‚

4. åœ¨4.0ä¹‹å‰AOFé‡å†™å®é™…ä¸Šè·Ÿrdbæ–‡ä»¶é€»è¾‘ç±»ä¼¼ï¼Œä¼šéå†å„ä¸ªdbï¼Œå¹¶ä¸”å°†ç°å­˜çš„key/value/è¿‡æœŸæ—¶é—´è¿™äº›ä¿¡æ¯å–å‡ºæ¥ï¼Œç„¶åè½¬æ¢æˆ â€œè®¾ç½®å‘½ä»¤â€ å­˜å…¥æ–°çš„AOFæ–‡ä»¶ä¸­ï¼Œè€çš„AOFæ–‡ä»¶å°±å¯ä»¥ä¸å†ä½¿ç”¨äº†ï¼Œæ–°AOFæ–‡ä»¶å…·æœ‰æ¢å¤æ•°æ®éœ€è¦çš„æœ€å°‘å‘½ä»¤ã€‚
"
### é¢è¯•å®˜: "AOFé‡å†™çš„é€»è¾‘ä½ äº†è§£å—ï¼Ÿ"
å€™é€‰äºº:  "
1. AOFé‡å†™é€»è¾‘è·ŸRDBå…¶å®æœ‰ç‚¹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯fork+copy on writeå¼€å­è¿›ç¨‹æ¥å®ŒæˆAOFæ–‡ä»¶çš„é‡å†™ï¼Œå¹¶å°†å­è¿›ç¨‹çš„pidè®°å½•åˆ° å…¨å±€å˜é‡ server.aof_child_pid ä¸­ã€‚

2. ä¸RDBä¸å¤ªä¸€æ ·çš„åœ°æ–¹
ä¸€ä¸ªæ˜¯ä¸Šé¢è¯´çš„ï¼ŒAOFä¼šå°†å½“å‰DBæ•°æ®ä»¥ "è®¾ç½®å‘½ä»¤"çš„æ–¹å¼å†™å…¥AOFæ–‡ä»¶ã€‚

3. å¦å¤–ä¸€ä¸ªå°±æ˜¯ï¼ŒAOFæ–‡ä»¶å†™å…¥æœŸé—´ï¼Œå‘ç”Ÿçš„æ–°çš„éœ€è¦å†™å…¥AOFæ–‡ä»¶çš„å‘½ä»¤ï¼Œä¼šè¢«è®°å½•åˆ°å…¨å±€çš„server.aof_rewrite_buf_blocks ä¸­ï¼Œè¯¥å˜é‡å®é™…ä¸Šæ˜¯ä¸€ä¸ªlistï¼Œæ¯ä¸€ä¸ªlistèŠ‚ç‚¹ä¼šæœ‰ä¸€å—å„¿bufferæ¥å­˜æ”¾å¢é‡å‘½ä»¤ï¼Œé»˜è®¤æ¯å—æ˜¯10MBã€‚
4. å½“AOFé‡å†™çš„å­è¿›ç¨‹ç»“æŸåè¿”å›ä¸€ä¸ªé€€å‡ºç ï¼Œä¸»è¿›ç¨‹åœ¨serverCronçš„è½®è¯¢ä¸­è°ƒç”¨ wait3()æ¥æ¥æ”¶AOFé‡å†™å­è¿›ç¨‹çš„ç»“æŸé€€å‡ºä¿¡æ¯ã€‚æ”¶åˆ°åï¼Œä¼šå°† server.aof_rewrite_buf_blocksä¸­çš„å†…å®¹åœ¨ä¸»çº¿ç¨‹ä¸­å†™å…¥AOFæ–‡ä»¶ã€‚å¹¶å°† server.aof_rewrite_buf_blocks, server.aof_bufæ¸…ç©ºï¼Œå°†server.aof_child_pid ç½®ä¸º-1
    > å°† server.aof_rewrite_buf_blocks å†™å…¥ AOF æ–‡ä»¶ è¿™ä¸ªæ“ä½œä¼šé˜»å¡ä¸»è¿›ç¨‹ï¼Œä½†å¦‚æœä¸è¿™ä¹ˆæ“ä½œå†å¼€å­è¿›ç¨‹æ¥å†™ï¼Œè¿™ä¼šä¸ä¼šé™·å…¥ä¸€ä¸ªä¹…ä¹…ä¸èƒ½ç»“æŸçš„å¾ªç¯ ğŸ¤”

5. 4.0ä¹‹åå¦‚æœå¼€äº†AOF-RDBæ··åˆæŒä¹…åŒ–ï¼ŒAOFé‡å†™æ—¶å…¨é‡æ•°æ®ä¿å­˜é‚£é‡Œæ¢æˆäº†ä¿å­˜rdbæ–‡ä»¶ï¼Œå¦å¤–æ¢å¤çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨RDBæ¢å¤ï¼Œå†ç”¨AOFå¢é‡æ¢å¤ï¼Œå…¶ä½™é€»è¾‘å€’æ˜¯å·®ä¸å¤ªå¤šã€‚
"
## é¢è¯•å®˜: "æœ€åä¸€ä¸ªé—®é¢˜" 
é¢è¯•å®˜: "ä½ æ˜å¤©èƒ½æ¥ä¸Šç­å—ï¼Ÿ"
å€™é€‰äºº: "ğŸ˜"


# å°ç»“
1. ä»å…¨å±€æ¥çœ‹ï¼Œredisçš„æ•°æ®å¤‡ä»½å®é™…ä¸Šå°±æ˜¯ å…¨é‡ + å¢é‡ ä¸¤ç§æ–¹å¼ã€‚
2. ä½†æ¯•ç«Ÿè¿™æ˜¯ç¨‹åºï¼Œåœ¨å®é™…å®ç°çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°çš„ç»†èŠ‚æ•°é‡è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚
3. redisçš„æ•°æ®å¤‡ä»½ä¸æ¢å¤ ä¸€æ–¹é¢å¯ä»¥ç”¨æ¥ç»™è‡ªå·±è¿™ä¸ªè¿›ç¨‹ç”¨ï¼Œå¦ä¸€æ–¹é¢ä¸»ä»å¤åˆ¶çš„ä¼¼ä¹ä¹Ÿæ˜¯æœ‰ç‚¹ç”¨çš„ï¼Œè¿™ä¸ªç­‰å†™ä¸»ä»å¤åˆ¶çš„æ—¶å€™å†çœ‹çœ‹ã€‚


 # å¾€æœŸåšå®¢å›é¡¾
1. [redisæœåŠ¡å™¨çš„éƒ¨åˆ†å¯åŠ¨è¿‡ç¨‹](https://blog.csdn.net/a158372582/article/details/106023071)
5.  [GETå‘½ä»¤èƒŒåçš„æºç é€»è¾‘](https://editor.csdn.net/md/?articleId=106035658)
6. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ sds](https://blog.csdn.net/a158372582/article/details/106063645)
7. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ list](https://blog.csdn.net/a158372582/article/details/106086284)
8. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ ziplist](https://blog.csdn.net/a158372582/article/details/106107759)
9. [redis åŸºç¡€æ•°æ®ç»“æ„ä¹‹ hashè¡¨](https://blog.csdn.net/a158372582/article/details/106234075)
10. [redisä¸ç¨³å®šå­—å…¸çš„éå†](https://blog.csdn.net/a158372582/article/details/106304649)
11. [redis åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ é›†åˆ](https://blog.csdn.net/a158372582/article/details/106202553)
12. [redis åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ æœ‰åºé›†åˆ](https://blog.csdn.net/a158372582/article/details/106630445) 
13. [redisObject ä»¥åŠ å¯¹æŠ½è±¡çš„ç†è§£](https://blog.csdn.net/a158372582/article/details/106712261)