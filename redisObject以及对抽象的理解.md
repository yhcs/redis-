
@[TOC](redisObject ä»¥åŠå¯¹æŠ½è±¡çš„ç†è§£)
# ç»™æ–°è§‚ä¼—è€çˆ·çš„å¼€åœº
å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å¼Ÿå¼Ÿï¼
æœ€è¿‘è¯»äº†ä¸€é é»„å¥å®å¤§ä½¬çš„ **<<Redis è®¾è®¡ä¸å®ç°>>**ï¼Œå¯¹Redis 3.0ç‰ˆæœ¬æœ‰äº†ä¸€äº›è®¤è¯†
è¯¥ä¹¦ä½œè€…æœ‰ä¸€ç‰ˆæ·»åŠ äº†æ³¨é‡Šçš„ redis 3.0æºç 
[ğŸ‘‰å®˜æ–¹redisçš„githubä¼ é€é—¨](https://github.com/antirez/redis)ã€‚
[ğŸ‘‰é»„å¥å®å¤§ä½¬æ·»åŠ äº†æ³¨é‡Šçš„ redis 3.0æºç ä¼ é€é—¨](https://github.com/huangz1990/redis-3.0-annotated.git)


ç½‘ä¸Šè¯´Redisä»£ç å†™å¾—å¾ˆå¥½ï¼Œä¸ºäº†åŠ æ·±å°è±¡å’Œå­¦ä¹ rediså¤§ä½¬çš„ä»£ç å†™ä½œè‰ºæœ¯ï¼Œäº†è§£å·¥ä½œä¸­ä½¿ç”¨çš„redis å‘½ä»¤èƒŒåçš„æºç é€»è¾‘ï¼Œä¾¿æœ‰äº†å†™åšå®¢è®°å½•å­¦ä¹ redisæºç è¿‡ç¨‹çš„æƒ³æ³•ã€‚


# redisObject
çœ‹è¿‡å‰å‡ æœŸçš„è§‚ä¼—è€çˆ·ï¼Œéƒ½ä¼šå¸¸å¸¸è§åˆ°ä¸€ä¸ªå« robj çš„ç»“æ„ä½“
æ¯”å¦‚åœ¨k/vç©ºé—´ä¸­æŸ¥è¯¢k/v, keyæ˜¯robjç±»å‹çš„æŒ‡é’ˆï¼Œè¿”å›çš„value ä¹Ÿæ˜¯robjç±»å‹çš„æŒ‡é’ˆğŸ‘‡
```javascript
/*
 * ä»æ•°æ®åº“ db ä¸­å–å‡ºé”® key çš„å€¼ï¼ˆå¯¹è±¡ï¼‰
 *
 * å¦‚æœ key çš„å€¼å­˜åœ¨ï¼Œé‚£ä¹ˆè¿”å›è¯¥å€¼ï¼›å¦åˆ™ï¼Œè¿”å› NULL ã€‚
 */
robj *lookupKey(redisDb *db, robj *key)
{
    // æŸ¥æ‰¾é”®ç©ºé—´
    dictEntry *de = dictFind(db->dict, key->ptr);
    // èŠ‚ç‚¹å­˜åœ¨
    if (de)
    {
        // å–å‡ºå€¼
        robj *val = dictGetVal(de);
		...
        // è¿”å›å€¼
        return val;
    }
    // èŠ‚ç‚¹ä¸å­˜åœ¨
    return NULL;
}
```
redisçš„k/vç©ºé—´é‡Œä¸æ˜¯æœ‰å¥½å¤šç§ç±»å‹çš„æ•°æ®ç»“æ„å—ï¼Ÿ
å¦‚æœè¯´keyéƒ½æ˜¯å­—ç¬¦ä¸²å¯ä»¥ç”¨ä¸€ä¸ªç±»å‹æ¥è¡¨ç¤ºï¼Œ
é‚£é“¾è¡¨ï¼Œé›†åˆï¼Œæœ‰åºé›†åˆï¼Œhashè¡¨å‘¢ï¼Ÿ
æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥å¯¹ä¸åŒçš„æ•°æ®ç»“æ„éƒ½å†™ä¸€å¥— å­˜å–k/vçš„é€»è¾‘å‘¢ï¼Ÿ

æ˜¾ç„¶æ˜¯åªå†™ä¸€å¥—æ˜¯æœ€ç®€å•çœäº‹çš„å“ˆ ğŸ¶

å¦‚æœæ¯ç§æ•°æ®ç»“æ„éƒ½æ¥ä¸€å¥—å¯¹åº”çš„ å­˜å–k/vé€»è¾‘ï¼Œ
ä¸ä»…å¢åŠ äº†å¼€å‘é‡ï¼Œè€Œä¸”å¼•å…¥äº†éå¸¸å¤šçš„å†—ä½™é€»è¾‘ï¼Œ
ä¸ä»…ä¸æ–¹ä¾¿äººé˜…è¯»ï¼Œè€Œä¸”ç³»ç»Ÿçš„æ··ä¹±ç¨‹åº¦ä¹Ÿä¼šå‡é«˜ï¼Œ
åšæ–°åŠŸèƒ½æ‰©å±•ä¸€ç±»çš„å¼€å‘ï¼Œä»£ç ä¼šè¶Šå†™è¶Šå±ğŸ’©

æŠ½è±¡å‡º redisObject çš„å¥½å¤„ï¼Œæ‹¿å­˜å–k/væ¥ä¸¾ä¾‹
1. æŠ½è±¡å±‚é¢ç›¸åŒé€»è¾‘çš„ä»£ç ä¸€å¥—å°±å¤Ÿäº†ã€‚ æ¯”å¦‚å­˜å–k/vçš„ä»£ç 
   > é’ˆå¯¹ä¸åŒæ•°æ®ç»“æ„æ¥ä¸€å¥—ç‰¹å®šçš„crudä»£ç ï¼Œè¿™ä¸ªæ˜¯æ²¡åŠæ³•é¿å…çš„äº‹æƒ…ã€‚

   > ä½†æ˜¯å¯¹äº k/v åœ¨redisä¸­çš„å­˜å–æ“ä½œï¼Œè¿™æ˜¯å¯ä»¥æŠ½è±¡å‡ºä¸€å¥—ä»£ç çš„ï¼Œ
   > å› ä¸ºä¸åŒæ•°æ®ç±»å‹çš„å¯¹è±¡éƒ½å¯ä»¥ç”¨ä¸€ä¸ªæŒ‡é’ˆæ¥æŒ‡å‘ä»–ä»¬ï¼Œ
   > å¯¹äºk/vçš„å­˜å–æœ€éœ€è¦å…³å¿ƒçš„æ˜¯ keyçš„æŒ‡é’ˆæ˜¯å“ªä¸ªï¼Œvalueçš„æŒ‡é’ˆæ˜¯å“ªä¸ªï¼Œ
   > k/v çš„æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ç±»å‹æ˜¯ä»€ä¹ˆ(ç±»å‹å˜é‡ï¼Œåªæ˜¯ä¸€ä¸ªæ•°å­—)ï¼Œç¼–ç æ–¹å¼æ˜¯ä»€ä¹ˆã€‚
   > è€Œå¯¹äº k/væŒ‡é’ˆæŒ‡å‘çš„å…·ä½“ç»“æ„åˆ°åº•é•¿å•¥æ ·ï¼Œå¯¹äºå­˜å–k/vçš„æŒ‡é’ˆè¿™ä¸ªæ“ä½œæ¥è¯´ å®é™…ä¸Šæ˜¯ä¸å…³å¿ƒçš„ã€‚
   > è°è¦è¯» å°± æ ¹æ®è¯»å‡ºæ¥çš„ æŒ‡é’ˆã€ç±»å‹å­—æ®µå’Œå®ç°æ–¹å¼ è‡ªå·±è§£æå°±å¥½äº†ã€‚ğŸ™ƒï¸
2. ä»£ç é€»è¾‘ç²¾ç®€ï¼Œæ¸…æ™°æ˜äº†
ä¾¿äºå¼€å‘è€…è‡ªå·±é˜…è¯»ï¼Œä¹Ÿä¾¿äºåæ¥çš„å…¶ä»–å¼€å‘è€…é˜…è¯»ï¼Œèµå¿ƒæ‚¦ç›®ã€‚
3. é™ä½ç³»ç»Ÿæ··ä¹±ç¨‹åº¦(å¢’å‡)ï¼Œç³»ç»Ÿå„ä¸ªéƒ¨åˆ†éƒ½ç®€å•æ˜äº†æ—¶ï¼Œç³»ç»Ÿä¼šæ¯”è¾ƒå¥å£®ï¼Œå®¹æ˜“æ‰©å±•
å› ä¸ºç®€å•å˜›ï¼Œæ‰€ä»¥ç›¸å¯¹å¤æ‚æ¥è¯´ä¸å®¹æ˜“å‡ºé”™ï¼Œå°±æ¯”è¾ƒå¥å£®ã€‚


   > æ˜¯å¦åœ¨å·¥ä½œä¸­æœ‰è¿™æ ·ä¸€ç§ä½“éªŒï¼Ÿ ä¿®äº†ä¸€ä¸ªbugï¼Œç»“æœå¤šäº†å¥½å‡ ä¸ªbugğŸ˜‚
   > è¿™ç§é—®é¢˜ä¸€éƒ¨åˆ†æ˜¯å› ä¸ºç³»ç»Ÿå¤ªæ··ä¹±ï¼Œå¯¹äºä¿®æ”¹é€ æˆçš„å½±å“ï¼Œäººåœ¨çŸ­æ—¶é—´ä¹‹å†…æ²¡åŠæ³•å¿«é€Ÿè¯„ä¼°/å‘ç°æ‰€æœ‰è¢«å½±å“çš„åœ°æ–¹ã€‚åªæœ‰ç­‰ä¸Šçº¿ã€æå‡ºä¸€å£å¤§é”…ä¹‹åæ‰å‘ç°åŸæ¥æ²¡æ”¹å¯¹ğŸ˜‚

   > äººè„‘æœ‰æ™ºæ…§ï¼Œä½†æ¥å—/å¤„ç†/è¾“å‡º ä¿¡æ¯çš„é€Ÿåº¦ï¼Œç›¸æ¯”äºç”µè„‘æ¥è¯´å·®å¤ªè¿œäº†ã€‚
   > é‡‘å­—å¡”åŸç†ä¸€ä¹¦ä¸­æåˆ° äººå¤§æ¦‚åŒä¸€æ—¶é—´æ¥æ”¶è¶…è¿‡7ä¸ªä¿¡æ¯æ—¶ï¼Œå°±ä¸å¤ªèƒ½è®°å…¨æ‰€æœ‰ä¿¡æ¯äº†ã€‚
   > å¦‚æœç³»ç»Ÿå¤ªè¿‡å¤æ‚ï¼Œè°¨æ…ä¿®bugğŸ˜‚
4. å› ç»“æ„ç®€å•å¸¦æ¥äº† å¯ä»¥ç»„åˆ/åµŒå¥—å‡ºå¤æ‚ç»“æ„çš„èƒ½åŠ›ã€‚
è¿™ç§èƒ½åŠ›è¦æ˜¯ä¸é€šè¿‡æŠ½è±¡è·å¾—ï¼Œæ— è„‘å†™ä»£ç å°†æ˜¯ä¸€åœºå™©æ¢¦ã€‚
   >  ä¸€ä¸ªhashè¡¨é‡Œï¼Œå¯ä»¥å­˜æ”¾å„ç§ç±»å‹çš„value, ç”šè‡³å¯ä»¥hashè¡¨é‡ŒåµŒå¥—ä¸€ä¸ªhashè¡¨ã€‚
   >  æ²¡é”™redisçš„å“ˆå¸Œæ•°æ®ç»“æ„å°±æ˜¯æ”¾åœ¨å…¨å±€çš„k/vå­—å…¸é‡Œçš„ï¼Œè¿™ä¸ªå…¨å±€k/vå­—å…¸å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªhashè¡¨
5. å¯¹è±¡å¼•ç”¨è®¡æ•°ï¼Œæ–¹ä¾¿å¯¹è±¡çš„å¤ç”¨ä¸é”€æ¯ï¼ŒèŠ‚çœç©ºé—´
6. è®°å½•å¯¹è±¡çš„è®¿é—®ä¿¡æ¯ï¼Œä»¥ä¾¿äºå†…å­˜ä¸è¶³æ—¶è¿›è¡Œå†…å­˜æ·˜æ±°

## redisObjectçš„ç»“æ„å®šä¹‰
redisObjectä¸€å…±æœ‰5ä¸ªå­—æ®µ
1. æŒ‡å‘å®é™…å¯¹è±¡çš„æŒ‡é’ˆ
2. å®é™…å¯¹è±¡çš„æ•°æ®ç»“æ„ç±»å‹
3. å®é™…å¯¹è±¡åœ¨ä¸€ä¸ªå…·ä½“æ•°æ®ç»“æ„ç±»å‹ä¸‹çš„ç¼–ç ç±»å‹
4. å¼•ç”¨è®¡æ•°
5. lruå­—æ®µ

ç»“æ„å®šä¹‰å¦‚ä¸‹ğŸ‘‡
```javascript
typedef struct redisObject
{

    // ç±»å‹
    unsigned type : 4;

    // ç¼–ç 
    unsigned encoding : 4;

    // å¯¹è±¡æœ€åä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´
    unsigned lru : REDIS_LRU_BITS; /* lru time (relative to server.lruclock) */

    // å¼•ç”¨è®¡æ•°
    int refcount;

    // æŒ‡å‘å®é™…å€¼çš„æŒ‡é’ˆ
    void *ptr;

} robj;
```
## redisObject æ¶µç›–çš„æ•°æ®ç±»å‹æœ‰å“ªäº›
åœ¨redis3.0é‡ŒredisObjectä¸€å…±æœ‰5ä¸­æ•°æ®ç±»å‹
```javascript
/* Object types */
// å¯¹è±¡ç±»å‹
#define REDIS_STRING 0
#define REDIS_LIST 1
#define REDIS_SET 2
#define REDIS_ZSET 3
#define REDIS_HASH 4
```
 > åœ¨è¾ƒæ–°ä¸€äº›çš„redis6.0é‡Œï¼ŒredisObjectä¸€å…±æœ‰7ç§ç±»å‹ã€‚

æ¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œåœ¨rediså†…éƒ¨éƒ½æœ‰2ç§åŠä»¥ä¸Šçš„ ç¼–ç æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå®ç°æ–¹å¼ã€‚
ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆæå‘¢ï¼Ÿ

ä¸»è¦æ˜¯è€ƒè™‘åˆ°redisä½œä¸ºä¸€ä¸ªå†…å­˜æ•°æ®åº“ï¼Œåœ¨keyå¯¹åº”çš„valueæ¯”è¾ƒå°æ—¶ï¼Œä½¿ç”¨æ›´èŠ‚çœå†…å­˜çš„æ–¹å¼å­˜å‚¨ã€‚
å½“keyå¯¹åº”çš„valueå…ƒç´ ä¸ªæ•°æˆ–å•ä¸ªå…ƒç´ è¿‡å¤§æ—¶ï¼Œä¼šè½¬æ¢æˆæ›´ä¸ºé€šç”¨çš„å®ç°æ–¹å¼ã€‚

åœ¨ä¹‹å‰å­¦ä¹ å„ä¸ªæ•°æ®ç»“æ„æ—¶ï¼Œä¼šç»å¸¸å‘ç°è¿™æ ·çš„æƒ…å†µï¼Œå†åˆ›å»ºå„ä¸ªæ•°æ®ç±»å‹æ—¶ï¼Œé»˜è®¤ä¼šå…ˆä»¥èŠ‚çœå†…å­˜çš„ç¼–ç æ–¹å¼åˆ›å»ºï¼Œå½“æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶ï¼Œä¼šè½¬æ¢ä¸ºæ›´ä¸ºé€šç”¨çš„ç¼–ç æ–¹å¼ã€‚

æ‰€æœ‰çš„ç¼–ç ç±»å‹å¦‚ä¸‹ğŸ‘‡	
```javascript
/* Objects encoding. Some kind of objects like Strings and Hashes can be
 * internally represented in multiple ways. The 'encoding' field of the object
 * is set to one of this fields for this object. */
// å¯¹è±¡ç¼–ç 
#define REDIS_ENCODING_RAW 0        ï¼ˆREDIS_STRINGï¼‰
#define REDIS_ENCODING_INT 1        ï¼ˆREDIS_STRINGï¼‰
#define REDIS_ENCODING_HT 2         ï¼ˆREDIS_SETï¼ŒREDIS_HASHï¼‰
#define REDIS_ENCODING_ZIPMAP 3     /* Encoded as zipmap */
#define REDIS_ENCODING_LINKEDLIST 4 ï¼ˆREDIS_LISTï¼‰
#define REDIS_ENCODING_ZIPLIST 5    ï¼ˆREDIS_LISTï¼ŒREDIS_HASH,REDIS_ZSETï¼‰
#define REDIS_ENCODING_INTSET 6     ï¼ˆREDIS_SETï¼‰
#define REDIS_ENCODING_SKIPLIST 7   ï¼ˆREDIS_ZSETï¼‰
#define REDIS_ENCODING_EMBSTR 8     ï¼ˆREDIS_STRINGï¼‰
```

## æ•°æ®ç»“æ„ç±»å‹åˆ¤æ–­
å‰é¢è¯´ï¼Œå½“ä»redisçš„dbä¸­å­˜å–k/væ—¶ï¼Œä½¿ç”¨äº†redisObjectç»“æ„ï¼Œæ²¡æœ‰å…³å¿ƒvalueçš„å…·ä½“ç»“æ„ã€‚
é‚£ä¹ˆå½“valueä»redisçš„dbä¸­å–å‡ºæ¥åï¼Œå†åšç›¸åº”é€»è¾‘ä¹‹å‰è¿˜æ˜¯è¦åˆ¤æ–­ä¸€ä¸‹valueçš„æ•°æ®ç»“æ„ç±»å‹ï¼Œ
å¦åˆ™æ˜¯ä¼šæœ‰é—®é¢˜çš„ã€‚

æ¯”å¦‚hget å‘½ä»¤å¯¹åº”çš„ hgetCommandå‘½ä»¤ï¼Œé€šè¿‡keyä»dbä¸­å–å‡ºvalueåï¼Œåˆ¤æ–­äº†valueæ˜¯å¦æ˜¯hashå¯¹è±¡
æºç é€»è¾‘å¦‚ä¸‹ğŸ‘‡
```javascript
void hgetCommand(redisClient *c) {
    robj *o;

    if ((o = lookupKeyReadOrReply(c,c->argv[1],shared.nullbulk)) == NULL ||
        checkType(c,o,REDIS_HASH)) return;

    // å–å‡ºå¹¶è¿”å›åŸŸçš„å€¼
    addHashFieldToReply(c, o, c->argv[2]);
}
/*
 * æ£€æŸ¥å¯¹è±¡ o çš„ç±»å‹æ˜¯å¦å’Œ type ç›¸åŒï¼š
 *
 *  - ç›¸åŒè¿”å› 0 
 *
 *  - ä¸ç›¸åŒè¿”å› 1 ï¼Œå¹¶å‘å®¢æˆ·ç«¯å›å¤ä¸€ä¸ªé”™è¯¯
 */
int checkType(redisClient *c, robj *o, int type) {

    if (o->type != type) {
        addReply(c,shared.wrongtypeerr);
        return 1;
    }

    return 0;
}
/*
 * ä¸ºæ‰§è¡Œè¯»å–æ“ä½œè€Œä»æ•°æ®åº“ä¸­æŸ¥æ‰¾è¿”å› key çš„å€¼ã€‚
 *
 * å¦‚æœ key å­˜åœ¨ï¼Œé‚£ä¹ˆè¿”å› key çš„å€¼å¯¹è±¡ã€‚
 *
 * å¦‚æœ key ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå‘å®¢æˆ·ç«¯å‘é€ reply å‚æ•°ä¸­çš„ä¿¡æ¯ï¼Œå¹¶è¿”å› NULL ã€‚
 */
robj *lookupKeyReadOrReply(redisClient *c, robj *key, robj *reply) {

    // æŸ¥æ‰¾
    robj *o = lookupKeyRead(c->db, key);

    // å†³å®šæ˜¯å¦å‘é€ä¿¡æ¯
    if (!o) addReply(c,reply);

    return o;
}
```
å®é™…ä¸Šè¿™ä¸ª ç”¨keyåœ¨redisçš„dbä¸­å–valueå¹¶åˆ¤æ–­ç±»å‹çš„æ“ä½œï¼Œåœ¨å„ç§æ•°æ®ç±»å‹ä¸Šéƒ½æ˜¯æœ‰çš„

æ¯”å¦‚ å–string
```javascript
void getCommand(redisClient *c) {
    getGenericCommand(c);
}
int getGenericCommand(redisClient *c) {
    robj *o;
    // å°è¯•ä»æ•°æ®åº“ä¸­å–å‡ºé”® c->argv[1] å¯¹åº”çš„å€¼å¯¹è±¡
    // å¦‚æœé”®ä¸å­˜åœ¨æ—¶ï¼Œå‘å®¢æˆ·ç«¯å‘é€å›å¤ä¿¡æ¯ï¼Œå¹¶è¿”å› NULL
    if ((o = lookupKeyReadOrReply(c, c->argv[1], shared.nullbulk)) == NULL) {
        return REDIS_OK;
    }
    // å€¼å¯¹è±¡å­˜åœ¨ï¼Œæ£€æŸ¥å®ƒçš„ç±»å‹
    if (o->type != REDIS_STRING) {
        // ç±»å‹é”™è¯¯
        addReply(c, shared.wrongtypeerr);
        return REDIS_ERR;
    }
    ...
 }
```
å–list
```javascript
void lindexCommand(redisClient *c) {

    robj *o = lookupKeyReadOrReply(c,c->argv[1],shared.nullbulk);

    if (o == NULL || checkType(c,o,REDIS_LIST)) return;
    ...
}
```
å…¶ä½™ç±»å‹...çœç•¥

å°†å…¬æœ‰é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼Œåªå†™ä¸€å¥—ä»£ç ã€‚ä¸åŒçš„å®ç°æ–¹å¼çš„å…·ä½“é€»è¾‘å†å†™ä¸åŒçš„ä»£ç ã€‚
ä¼¼ä¹è¿˜ä¸é”™ğŸ¤”

## å¯¹è±¡å¼•ç”¨è®¡æ•°
Cè¯­è¨€æ˜¯æ²¡æœ‰GCçš„ï¼Œè‡ªå·±ç”³è¯·çš„å†…å­˜è¿˜å¾—è‡ªå·±é‡Šæ”¾ã€‚

æ¯”å¦‚Bå‡½æ•°é€šè¿‡Aå‡½æ•°å¾—åˆ°äº†ä¸€ä¸ªrobj*ç±»å‹çš„å˜é‡C ï¼ŒBå‡½æ•°ç”¨å®Œä¹‹åç†æ‰€åº”å½“çš„è¦é‡Šæ”¾æ‰Cã€‚
ä½†æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼Œè¿™ä¸ªCåˆ«äººæœ‰æ²¡æœ‰åœ¨ç”¨å‘¢ï¼Ÿå¦‚æœåªæ˜¯Bè‡ªå·±åœ¨ç”¨é‚£é‡Šæ”¾æ‰å°±é‡Šæ”¾äº†ã€‚
å¦‚æœæœ‰åˆ«äººåœ¨ç”¨ï¼Œè¿™ä¸ªCè¿˜ä¸èƒ½é©¬ä¸Šé‡Šæ”¾ã€‚

redisä½œè€…æäº†ä¸€ä¸ªç®€å•çš„å¯¹è±¡å¼•ç”¨è®¡æ•°ï¼Œæ¥è§£å†³å†…å­˜å¤ç”¨ä¸é”€æ¯çš„é—®é¢˜ã€‚
1. è°è¦"æ‹·è´"è¿™ä¸ªredisObjectï¼Œå¼•ç”¨è®¡æ•°å°±+1
2.  è°ç”¨å®Œäº†è¿™ä¸ªredisObjectï¼Œå¼•ç”¨è®¡æ•°å°±-1
å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œfreeæ‰redisObjectå ç”¨çš„å†…å­˜ç©ºé—´

ä¸¾ä¸ªæºç ä¾‹å­
æ¯”å¦‚åˆ¤æ–­hashè¡¨ä¸­çš„keyæ˜¯å¦ä¸è¾“å…¥çš„keyç›¸ç­‰ 
å› ä¸ºå­—ç¬¦ä¸²ç±»å‹åº•å±‚æœ‰å¤šç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œåœ¨æ¯”è¾ƒçš„æ—¶å€™éœ€è¦ç»Ÿä¸€çš„ä¸€ç§å½¢å¼ã€‚
getDecodedObject ä¼šè¿”å›ç»™å®š robjçš„ REDIS_ENCODING_RAW ç¼–ç å½¢å¼ã€‚
1. å¦‚æœrobj çš„ç¼–ç å°±æ˜¯ REDIS_ENCODING_RAW é‚£ä¹ˆå¯ä»¥å¤ç”¨è¯¥å†…å­˜ï¼Œä»…å¢åŠ å¼•ç”¨è®¡æ•°å³å¯
2. å¦åˆ™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ REDIS_ENCODING_RAWç¼–ç çš„robj å­—ç¬¦ä¸²ï¼Œå¼•ç”¨è®¡æ•°åˆå§‹ä¸º1
3. æ¯”å¯¹å®Œä¹‹åå¯¹ getDecodedObject è¿”å›çš„ç»“æ„ä½“ å‡1ä¸ªå¼•ç”¨è®¡æ•°ï¼Œè‹¥å¼•ç”¨è®¡æ•°å‡ä¸º0ï¼Œåˆ™é‡Šæ”¾è¯¥ç»“æ„ä½“
> éå­—ç¬¦ä¸²ç±»å‹çš„robjä¼šå´©æºƒ

```javascript
int dictEncObjKeyCompare(void *privdata, const void *key1,
        const void *key2)
{
    robj *o1 = (robj*) key1, *o2 = (robj*) key2;
    int cmp;

    if (o1->encoding == REDIS_ENCODING_INT &&
        o2->encoding == REDIS_ENCODING_INT)
            return o1->ptr == o2->ptr;

    o1 = getDecodedObject(o1);
    o2 = getDecodedObject(o2);
    cmp = dictSdsKeyCompare(privdata,o1->ptr,o2->ptr);
    decrRefCount(o1);
    decrRefCount(o2);
    return cmp;
}


/* Get a decoded version of an encoded object (returned as a new object).
 *
 * ä»¥æ–°å¯¹è±¡çš„å½¢å¼ï¼Œè¿”å›ä¸€ä¸ªè¾“å…¥å¯¹è±¡çš„è§£ç ç‰ˆæœ¬ï¼ˆRAW ç¼–ç ï¼‰ã€‚
 *
 * If the object is already raw-encoded just increment the ref count. 
 *
 * å¦‚æœå¯¹è±¡å·²ç»æ˜¯ RAW ç¼–ç çš„ï¼Œé‚£ä¹ˆå¯¹è¾“å…¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢ä¸€ï¼Œ
 * ç„¶åè¿”å›è¾“å…¥å¯¹è±¡ã€‚
 */
robj *getDecodedObject(robj *o) {
    robj *dec;

    if (sdsEncodedObject(o)) {
        incrRefCount(o);
        return o;
    }

    // è§£ç å¯¹è±¡ï¼Œå°†å¯¹è±¡çš„å€¼ä»æ•´æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²
    if (o->type == REDIS_STRING && o->encoding == REDIS_ENCODING_INT) {
        char buf[32];

        ll2string(buf,32,(long)o->ptr);
        dec = createStringObject(buf,strlen(buf));
        return dec;

    } else {
        redisPanic("Unknown encoding type");
    }
}

/*
 * ä¸ºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢ä¸€
 */
void incrRefCount(robj *o) {
    o->refcount++;
}
/*
 * ä¸ºå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å‡ä¸€
 *
 * å½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°é™ä¸º 0 æ—¶ï¼Œé‡Šæ”¾å¯¹è±¡ã€‚
 */
void decrRefCount(robj *o) {

    if (o->refcount <= 0) redisPanic("decrRefCount against refcount <= 0");

    // é‡Šæ”¾å¯¹è±¡
    if (o->refcount == 1) {
        switch(o->type) {
        case REDIS_STRING: freeStringObject(o); break;
        case REDIS_LIST: freeListObject(o); break;
        case REDIS_SET: freeSetObject(o); break;
        case REDIS_ZSET: freeZsetObject(o); break;
        case REDIS_HASH: freeHashObject(o); break;
        default: redisPanic("Unknown object type"); break;
        }
        zfree(o);

    // å‡å°‘è®¡æ•°
    } else {
        o->refcount--;
    }
}
```
## lruå­—æ®µ ä¸ å†…å­˜æ·˜æ±°
redisObjectä¸­çš„lruå­—æ®µè®°å½•äº†k/vè¢«è®¿é—®çš„ æ—¶é—´ or é¢‘ç‡ ç›¸å…³ä¿¡æ¯ã€‚
è¿™ä¸ªlruå­—æ®µ åªå äº†24ä½ç©ºé—´

åœ¨å†…å­˜ä¸è¶³æ—¶ä½œä¸ºå‚è€ƒæ•°æ®ï¼Œæ ¹æ®æ·˜æ±°ç­–ç•¥è¿›è¡Œæ•°æ®æ·˜æ±°ï¼Œä»¥é‡Šæ”¾ç©ºé—´ã€‚
è¿™ä¸ªredisçš„å†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å¤šç§æ–¹å¼ï¼Œå¯ä»¥å•ç‹¬å†™ä¸€ç¯‡åšå®¢äº†ï¼Œåœ¨è¿™é‡Œå…ˆä¸ç»†è¯´äº†ã€‚ğŸ¶



# å°ç»“
1. å†™ä»£ç çš„æ—¶å€™æœ€å…ˆæƒ³åˆ°çš„å°±æ˜¯å…·ä½“å¦‚ä½•å®ç°ï¼Œè¿™ä¸ªæƒ³æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚
ä½†è¿™æ˜¯å±€éƒ¨è§†è§’ï¼Œå¹¶ä¸å®Œæ•´ï¼Œç¼ºå°‘ç«™åœ¨ç³»ç»Ÿæ•´ä½“å±‚é¢çš„æ€è€ƒã€‚
æ‰€å†™çš„ä»£ç æ¨¡å—ï¼Œåœ¨æ•´ä¸ªç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªä»€ä¹ˆå®šä½ï¼Œä¸ç³»ç»Ÿä¸­å…¶ä»–æ¨¡å—æœ‰ä»€ä¹ˆå…³ç³»ã€‚
æ‰€å†™ä»£ç æ¨¡å—æœ¬èº«æ˜¯å¦æœ‰æ›´å¥½çš„ç»„ç»‡æ–¹å¼ã€‚
ç³»ç»Ÿå±‚é¢çš„æ•´ä½“æ€è€ƒ è·Ÿ å…·ä½“åŠŸèƒ½å¦‚ä½•å®ç° ä¸€æ ·é‡è¦ã€‚(è·‘é¢˜äº†ğŸ¶)




 # å¾€æœŸåšå®¢å›é¡¾
1. [redisæœåŠ¡å™¨çš„éƒ¨åˆ†å¯åŠ¨è¿‡ç¨‹](https://blog.csdn.net/a158372582/article/details/106023071)
3.  [GETå‘½ä»¤èƒŒåçš„æºç é€»è¾‘](https://editor.csdn.net/md/?articleId=106035658)
4. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ sds](https://blog.csdn.net/a158372582/article/details/106063645)
5. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ä¹‹ list](https://blog.csdn.net/a158372582/article/details/106086284)
6. [redisçš„åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ ziplist](https://blog.csdn.net/a158372582/article/details/106107759)
7. [redis åŸºç¡€æ•°æ®ç»“æ„ä¹‹ hashè¡¨](https://blog.csdn.net/a158372582/article/details/106234075)
8. [redisä¸ç¨³å®šå­—å…¸çš„éå†](https://blog.csdn.net/a158372582/article/details/106304649)
9. [redis åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ é›†åˆ](https://blog.csdn.net/a158372582/article/details/106202553)
10. [redis åŸºç¡€æ•°æ®ç»“æ„ ä¹‹ æœ‰åºé›†åˆ](https://blog.csdn.net/a158372582/article/details/106630445) 